<!DOCTYPE html>
<html>
<head>
    <title>DEBUG - Autenticaci√≥n</title>
    <style>
        body { font-family: monospace; background: #1a1a1a; color: #00ff00; padding: 20px; }
        .log { margin: 5px 0; padding: 5px; border-left: 3px solid #444; }
        .success { border-color: #00ff00; color: #00ff00; }
        .error { border-color: #ff0000; color: #ff0000; }
        .warning { border-color: #ffff00; color: #ffff00; }
        .info { border-color: #0088ff; color: #0088ff; }
        input, button { 
            background: #2a2a2a; 
            color: white; 
            border: 1px solid #444; 
            padding: 10px; 
            margin: 5px; 
            width: 300px; 
            display: block; 
        }
        button { background: #0088ff; cursor: pointer; }
        button:hover { background: #0066cc; }
        #console { 
            background: #000; 
            padding: 15px; 
            margin-top: 20px; 
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üîß DEBUG - Sistema de Autenticaci√≥n</h1>
    
    <div>
        <h3>1. Verificar Supabase</h3>
        <button onclick="verificarSupabase()">Comprobar Conexi√≥n Supabase</button>
        
        <h3>2. Probar Registro</h3>
        <input type="text" id="debug-nombre" placeholder="Nombre" value="Juan P√©rez">
        <input type="email" id="debug-email" placeholder="Email" value="test@example.com">
        <input type="password" id="debug-password" placeholder="Contrase√±a" value="123456">
        <button onclick="debugRegistro()">Registrar Usuario</button>
        
        <h3>3. Probar Login</h3>
        <button onclick="debugLogin()">Iniciar Sesi√≥n (mismo usuario)</button>
        
        <h3>4. Verificar Sesi√≥n</h3>
        <button onclick="debugVerificarSesion()">¬øEstoy logueado?</button>
        
        <h3>5. Cerrar Sesi√≥n</h3>
        <button onclick="debugLogout()">Cerrar Sesi√≥n</button>
    </div>
    
    <div id="console">
        <!-- Aqu√≠ aparecer√°n los logs -->
        <div class="log info">üîç Consola de depuraci√≥n lista...</div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <script>
        // ========== LOGGER ==========
        function log(mensaje, tipo = 'info') {
            const consoleDiv = document.getElementById('console');
            const logEntry = document.createElement('div');
            logEntry.className = `log ${tipo}`;
            logEntry.innerHTML = `[${new Date().toLocaleTimeString()}] ${mensaje}`;
            consoleDiv.appendChild(logEntry);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            console.log(`[${tipo.toUpperCase()}] ${mensaje}`);
        }
        
        // ========== CONFIGURACI√ìN SUPABASE ==========
        // REEMPLAZA ESTOS VALORES CON LOS TUYOS
        const SUPABASE_URL = 'https://owimgqvbybwzylszlomo.supabase.co';  // CAMBIAR
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im93aW1ncXZieWJ3enlsc3psb21vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4OTQ0NTgsImV4cCI6MjA4MTQ3MDQ1OH0.lCBNgE3zOG3qJNkX-ls9n11vEHtGD719QeKrnu9Tvak';  // CAMBIAR
        
        log('üîÑ Inicializando debug...', 'info');
        
        // Crear cliente Supabase
        let supabase;
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            log('‚úÖ Cliente Supabase creado', 'success');
        } catch (error) {
            log(`‚ùå Error creando cliente Supabase: ${error.message}`, 'error');
        }
        
        // ========== FUNCIONES DEBUG ==========
        
        // 1. Verificar Supabase
        async function verificarSupabase() {
            log('üîç Verificando conexi√≥n con Supabase...', 'info');
            
            if (!supabase) {
                log('‚ùå Supabase no est√° definido', 'error');
                return;
            }
            
            try {
                // Prueba simple: obtener sesi√≥n
                const { data, error } = await supabase.auth.getSession();
                
                if (error) {
                    log(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
                    log(`üìã C√≥digo: ${error.code}`, 'info');
                } else {
                    log('‚úÖ Conexi√≥n exitosa con Supabase', 'success');
                    log(`üìä Sesi√≥n: ${data.session ? 'ACTIVA' : 'INACTIVA'}`, 'info');
                    
                    if (data.session) {
                        log(`üë§ Usuario: ${data.session.user.email}`, 'success');
                    }
                }
                
                // Verificar URL y KEY
                log(`üîó URL: ${SUPABASE_URL.substring(0, 30)}...`, 'info');
                log(`üîë KEY: ${SUPABASE_KEY.substring(0, 20)}...`, 'warning');
                
            } catch (error) {
                log(`üî• Error cr√≠tico: ${error.message}`, 'error');
            }
        }
        
        // 2. Probar Registro
        async function debugRegistro() {
            const nombre = document.getElementById('debug-nombre').value;
            const email = document.getElementById('debug-email').value;
            const password = document.getElementById('debug-password').value;
            
            log(`üìù Intentando registrar: ${email}`, 'info');
            
            if (!supabase) {
                log('‚ùå Supabase no disponible', 'error');
                return;
            }
            
            try {
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            nombre_completo: nombre,
                            telefono: '123456789'
                        }
                    }
                });
                
                if (error) {
                    log(`‚ùå Error en registro: ${error.message}`, 'error');
                    log(`üìã C√≥digo: ${error.code}`, 'info');
                    
                    // Errores comunes
                    if (error.message.includes('already registered')) {
                        log('üí° El usuario ya est√° registrado. Prueba con otro email.', 'warning');
                    }
                    if (error.message.includes('password')) {
                        log('üí° La contrase√±a debe tener al menos 6 caracteres', 'warning');
                    }
                    if (error.message.includes('email')) {
                        log('üí° El email no es v√°lido', 'warning');
                    }
                    
                } else {
                    log('‚úÖ Registro exitoso', 'success');
                    
                    if (data.user) {
                        log(`üë§ Usuario creado: ${data.user.email}`, 'success');
                        log(`üÜî ID: ${data.user.id}`, 'info');
                        
                        // Verificar si necesita confirmaci√≥n
                        if (data.user.identities && data.user.identities.length === 0) {
                            log('üìß El usuario necesita confirmar su email', 'warning');
                        }
                    }
                    
                    // Guardar en localStorage para pruebas
                    localStorage.setItem('debug_user_email', email);
                    localStorage.setItem('debug_user_password', password);
                }
                
            } catch (error) {
                log(`üî• Error inesperado: ${error.message}`, 'error');
                log(`üìã Stack: ${error.stack}`, 'error');
            }
        }
        
        // 3. Probar Login
        async function debugLogin() {
            const email = document.getElementById('debug-email').value;
            const password = document.getElementById('debug-password').value;
            
            log(`üîë Intentando login: ${email}`, 'info');
            
            if (!supabase) {
                log('‚ùå Supabase no disponible', 'error');
                return;
            }
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) {
                    log(`‚ùå Error en login: ${error.message}`, 'error');
                    log(`üìã C√≥digo: ${error.code}`, 'info');
                    
                    // Errores comunes
                    if (error.message.includes('Invalid login credentials')) {
                        log('üí° Credenciales incorrectas. ¬øEl usuario est√° registrado?', 'warning');
                    }
                    if (error.message.includes('Email not confirmed')) {
                        log('üí° El email no ha sido confirmado. Revisa tu correo.', 'warning');
                    }
                    
                } else {
                    log('‚úÖ Login exitoso', 'success');
                    log(`üë§ Usuario: ${data.user.email}`, 'success');
                    log(`üÜî ID: ${data.user.id}`, 'info');
                    
                    // Verificar que la sesi√≥n est√© activa
                    const sessionCheck = await supabase.auth.getSession();
                    log(`üìä Sesi√≥n activa: ${sessionCheck.data.session ? '‚úÖ S√ç' : '‚ùå NO'}`, 
                        sessionCheck.data.session ? 'success' : 'error');
                }
                
            } catch (error) {
                log(`üî• Error inesperado: ${error.message}`, 'error');
            }
        }
        
        // 4. Verificar Sesi√≥n
        async function debugVerificarSesion() {
            log('üîç Verificando sesi√≥n activa...', 'info');
            
            if (!supabase) {
                log('‚ùå Supabase no disponible', 'error');
                return;
            }
            
            try {
                const { data, error } = await supabase.auth.getSession();
                
                if (error) {
                    log(`‚ùå Error verificando sesi√≥n: ${error.message}`, 'error');
                } else {
                    if (data.session) {
                        log(`‚úÖ Sesi√≥n ACTIVA`, 'success');
                        log(`üë§ Usuario: ${data.session.user.email}`, 'success');
                        log(`üìß Email: ${data.session.user.email}`, 'info');
                        log(`üÜî ID: ${data.session.user.id}`, 'info');
                        log(`üìÖ Creado: ${new Date(data.session.user.created_at).toLocaleString()}`, 'info');
                        log(`üîë Rol: ${data.session.user.role}`, 'info');
                    } else {
                        log('‚ÑπÔ∏è No hay sesi√≥n activa', 'info');
                    }
                }
                
            } catch (error) {
                log(`üî• Error inesperado: ${error.message}`, 'error');
            }
        }
        
        // 5. Cerrar Sesi√≥n
        async function debugLogout() {
            log('üö™ Cerrando sesi√≥n...', 'info');
            
            if (!supabase) {
                log('‚ùå Supabase no disponible', 'error');
                return;
            }
            
            try {
                const { error } = await supabase.auth.signOut();
                
                if (error) {
                    log(`‚ùå Error cerrando sesi√≥n: ${error.message}`, 'error');
                } else {
                    log('‚úÖ Sesi√≥n cerrada correctamente', 'success');
                }
                
            } catch (error) {
                log(`üî• Error inesperado: ${error.message}`, 'error');
            }
        }
        
        // ========== INICIALIZACI√ìN ==========
        log('‚úÖ Debugger cargado. Presiona los botones para probar.', 'success');
        
        // Auto-verificar al cargar
        setTimeout(() => {
            verificarSupabase();
            debugVerificarSesion();
        }, 1000);
        
    </script>
</body>
</html>